{% extends 'base.html' %}

{% block title %}–†–∞—Å—Å—ã–ª–∫–∞ #{{ mailing.id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3>–î–µ—Ç–∞–ª–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ #{{ mailing.id }}</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                        <table class="table">
                            <tr>
                                <th style="width: 200px;">–°—Ç–∞—Ç—É—Å:</th>
                                <td>
                                    {% if mailing.status == 'created' %}
                                        <span class="badge bg-secondary">–°–æ–∑–¥–∞–Ω–∞</span>
                                    {% elif mailing.status == 'started' %}
                                        <span class="badge bg-success">–ó–∞–ø—É—â–µ–Ω–∞</span>
                                    {% elif mailing.status == 'completed' %}
                                        <span class="badge bg-danger">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</th>
                                <td>{{ mailing.start_time|date:"d.m.Y H:i" }}</td>
                            </tr>
                            <tr>
                                <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</th>
                                <td>{{ mailing.end_time|date:"d.m.Y H:i" }}</td>
                            </tr>
                            <tr>
                                <th>–°–æ–æ–±—â–µ–Ω–∏–µ:</th>
                                <td>
                                    <strong>{{ mailing.message.subject }}</strong>
                                    <p class="mt-2">{{ mailing.message.body|linebreaks }}</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ ({{ mailing.recipients.count }})</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>–§.–ò.–û.</th>
                                        <th>Email</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for recipient in mailing.recipients.all %}
                                        <tr>
                                            <td>{{ recipient.full_name }}</td>
                                            <td>{{ recipient.email }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="2" class="text-muted">–ù–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>–ü–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h5>
                        {% with attempts=mailing.attempts.all %}
                            {% if attempts %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                                                <th>–°—Ç–∞—Ç—É—Å</th>
                                                <th>–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for attempt in attempts|slice:":10" %}
                                                <tr>
                                                    <td>{{ attempt.attempt_time|date:"d.m.Y H:i:s" }}</td>
                                                    <td>
                                                        {% if attempt.status == 'success' %}
                                                            <span class="badge bg-success">–£—Å–ø–µ—à–Ω–æ</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ attempt.server_response|default:"-"|truncatechars:50 }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% if attempts.count > 10 %}
                                        <p class="text-muted">–ü–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∏–∑ {{ attempts.count }} –ø–æ–ø—ã—Ç–æ–∫</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <p class="text-muted">–ü–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'mailings:mailing_list' %}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
                <a href="{% url 'mailings:mailing_update' mailing.pk %}" class="btn btn-warning">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'mailings:mailing_delete' mailing.pk %}" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</a>
            </div>
        </div>
    </div>
    <!-- –û–¢–õ–ê–î–ö–ê: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Å—ã–ª–∫–µ -->
    <div class="alert alert-info">
        <strong>–û—Ç–ª–∞–¥–∫–∞:</strong><br>
        ID —Ä–∞—Å—Å—ã–ª–∫–∏: {{ mailing.id }}<br>
        –°—Ç–∞—Ç—É—Å: {{ mailing.status }}<br>
        URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {% url 'mailings:mailing_send' mailing.id %}<br>
        {% url 'mailings:mailing_send' mailing.id as test_url %}
        –ü—Ä–æ–≤–µ—Ä–∫–∞ URL: {{ test_url }}
    </div>

    {% if mailing.status == 'started' %}
    <div class="card mt-4 border-success">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <p>
                        <strong>–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</strong> {{ mailing.recipients.count }}<br>
                        <strong>–¢–µ–º–∞:</strong> {{ mailing.message.subject }}<br>
                        <strong>–¢–µ–∫—Å—Ç:</strong> {{ mailing.message.body|truncatechars:100 }}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <form action="{% url 'mailings:mailing_send' mailing.pk %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-lg"
                                onclick="return confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?\n\n–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: {{ mailing.recipients.count }}\n–¢–µ–º–∞: {{ mailing.message.subject }}')">
                            <span style="font-size: 1.5em;">üöÄ</span><br>
                            –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}